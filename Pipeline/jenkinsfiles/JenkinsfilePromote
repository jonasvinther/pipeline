node('windows') {
    try {

        artifactoryApiPath = withCredentials([string(credentialsId: 'artifactory-url', variable: 'ARTIFACTORY_URL')]) {
            return "http://${ARTIFACTORY_URL}/artifactory/api"
        }
        
        def workspacePath = "C:/Jenkins/workspace/BD.build/WebApplication1"
        artifactoryRepository = 'demo-local'

        stage('Preparation') {
            checkout scm
        }

        stage('Promote artifact') {
            // Flyt kun artifact til ny mappe hvis deploy + test er g√•et godt
            moveArtifact(27, 'T', 'S')
            //getLatestArtifact('T')
        }

    }
    catch (e) {
 
    } finally {
        
    }

}


def generateArtifactoryAuthInfo() {
    withCredentials([[
        $class: 'UsernamePasswordMultiBinding', 
        credentialsId: 'artifactory', 
        usernameVariable: 'username', 
        passwordVariable: 'password'
    ]]) {
        return powershell(
            script: "[Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(('{0}:{1}' -f '${username}','${password}')))", returnStdout: true
            ).trim()
    }
}

def moveArtifact(buildNumber, from, to) {
    def artifactoryBase64AuthInfo = generateArtifactoryAuthInfo()
    echo "${buildNumber} ${from} ${to} ${artifactoryBase64AuthInfo} ${artifactoryApiPath} ${artifactoryRepository}"
    powershell(". '.\\Pipeline\\build_scripts\\MoveArtifact.ps1' ${buildNumber} ${from} ${to} ${artifactoryBase64AuthInfo} ${artifactoryApiPath} ${artifactoryRepository}")
}

def getLatestArtifact(from) {
    def artifactoryBase64AuthInfo = generateArtifactoryAuthInfo()
    echo "${from} ${artifactoryBase64AuthInfo} ${artifactoryApiPath} ${artifactoryRepository}"
    powershell(". '.\\Pipeline\\build_scripts\\GetLatestArtifact.ps1' ${from} ${artifactoryBase64AuthInfo} ${artifactoryApiPath} ${artifactoryRepository}")
}